<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kinger AI - Unleashed Beyond</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    </head>
<body>
    <div class="kinger-ultimate-beyond-container kinger-ultimate-beyond-neumorphic"> <div id="vanta-net"></div> <header class="kinger-ultimate-beyond-header">
            <div class="kinger-ultimate-beyond-logo">
                <svg viewBox="0 0 64 64" fill="currentColor" class="kinger-ultimate-beyond-logo-icon kinger-ultimate-beyond-logo-iridescent"> <path d="M32 2L2 32l30 30 30-30L32 2zm0 10l18 18-18 18-18-18 18-18z"/>
                </svg>
                <span class="kinger-ultimate-beyond-logo-text">Kinger AI</span>
            </div>
            <div class="kinger-ultimate-beyond-actions">
                <button id="clearButton" class="kinger-ultimate-beyond-button kinger-ultimate-beyond-neumorphic-button" title="Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ⁄ØŸÅÿ™⁄ØŸà">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="kinger-ultimate-beyond-icon">
                        <path fill-rule="evenodd" d="M16.5 4.47a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1 0 1.06l-14.5 14.5a.75.75 0 0 1-1.06 0l-2.25-2.25a.75.75 0 0 1 0-1.06L16.5 4.47Zm-4.02 2.48a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 0 1-1.06 0l-.001-.002a.75.75 0 0 1 0-1.06l2.25-2.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                        <path d="M8.25 9.75a3.75 3.75 0 1 0 7.5 0v8.25a3 3 0 0 1-3 3h-1.5a3 3 0 0 1-3-3V9.75Z" />
                    </svg>
                </button>
                <button id="themeButton" class="kinger-ultimate-beyond-button kinger-ultimate-beyond-neumorphic-button" title="ÿ™ÿ∫€å€åÿ± ÿ™ŸÖ">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="kinger-ultimate-beyond-icon theme-dark-icon">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM12 18a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V18.75a.75.75 0 0 1 .75-.75ZM4.922 4.922a.75.75 0 0 1 1.06 0l1.5 1.5a.75.75 0 0 1-1.06 1.06l-1.5-1.5a.75.75 0 0 1 0-1.06ZM17.515 17.515a.75.75 0 0 1 1.06 0l1.5 1.5a.75.75 0 0 1-1.06 1.06l-1.5-1.5a.75.75 0 0 1 0-1.06ZM21 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5H20.25A.75.75 0 0 1 21 12ZM3 12a.75.75 0 0 1 .75.75H6a.75.75 0 0 1 0-1.5H3.75A.75.75 0 0 1 3 12ZM4.922 19.078a.75.75 0 0 1 0 1.06l-1.5 1.5a.75.75 0 0 1-1.06-1.06l1.5-1.5a.75.75 0 0 1 1.06 0ZM17.515 6.407a.75.75 0 0 1 0 1.06l-1.5 1.5a.75.75 0 0 1-1.06-1.06l1.5-1.5a.75.75 0 0 1 1.06 0Z" />
                    </svg>
                    <svg viewBox="0 0 24 24" fill="currentColor" class="kinger-ultimate-beyond-icon theme-light-icon hidden">
                        <path d="M12 2.25a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V3a.75.75 0 0 1 .75-.75ZM12 19.5a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0V20.25a.75.75 0 0 1 .75-.75ZM3 12a.75.75 0 0 1 .75.75h1.5a.75.75 0 0 1 0-1.5H3.75A.75.75 0 0 1 3 12ZM19.5 12a.75.75 0 0 1 .75.75h1.5a.75.75 0 0 1 0-1.5H20.25A.75.75 0 0 1 19.5 12ZM4.213 4.213a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 0 1-1.06 1.06L4.213 5.273a.75.75 0 0 1 0-1.06ZM18.787 18.787a.75.75 0 0 1 1.06 0l1.06 1.06a.75.75 0 0 1-1.06 1.06L18.787 19.847a.75.75 0 0 1 0-1.06ZM18.787 5.273a.75.75 0 0 1 0 1.06l-1.06 1.06a.75.75 0 0 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0ZM4.213 19.847a.75.75 0 0 1 0 1.06l-1.06 1.06a.75.75 0 0 1-1.06-1.06l1.06-1.06a.75.75 0 0 1 1.06 0Z" />
                    </svg>
                </button>
            </div>
        </header>
        <main class="kinger-ultimate-beyond-chat-area">
            <div id="chatbox" class="kinger-ultimate-beyond-chatbox">
                <div id="empty-state" class="kinger-ultimate-beyond-empty-state">
                    <div id="empty-state-animation"></div>
                    <p class="kinger-ultimate-beyond-empty-state-text">ŸÅÿ±ÿßÿ™ÿ± ÿßÿ≤ ÿ™ÿµŸàÿ±...</p>
                </div>
            </div>
            <div id="api2-spinner" class="kinger-ultimate-beyond-spinner-container hidden">
                <div class="kinger-ultimate-beyond-spinner"></div>
                <span class="kinger-ultimate-beyond-spinner-text">üåå ÿØÿ± ÿ≠ÿßŸÑ ⁄©ÿßŸàÿ¥...</span>
            </div>
            <div id="api2-error" class="kinger-ultimate-beyond-error-message hidden"></div>
        </main>
        <footer class="kinger-ultimate-beyond-input-area">
            <div class="kinger-ultimate-beyond-input-wrapper">
                <input type="text" id="chatInput" class="kinger-ultimate-beyond-input-field kinger-ultimate-beyond-neumorphic-input" placeholder="Ÿæ€åÿßŸÖ€å ÿ®ÿ±ÿß€å ÿ≥ŸÅÿ± ÿ®Ÿá ÿßÿπŸÖÿßŸÇ..." />
            </div>
            <div class="kinger-ultimate-beyond-input-buttons">
                <button id="sendButton" class="kinger-ultimate-beyond-button kinger-ultimate-beyond-neumorphic-button kinger-ultimate-beyond-button-animated" title="ÿßÿ±ÿ≥ÿßŸÑ">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="kinger-ultimate-beyond-icon">
                        <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5h-7.126l8.612 2.82a.75.75 0 0 0 1.154-.342l3.579-9.255A.75.75 0 0 0 18.214 2.405H3.478Z" />
                    </svg>
                </button>
                <button id="imageButton" class="kinger-ultimate-beyond-button kinger-ultimate-beyond-neumorphic-button kinger-ultimate-beyond-button-animated" title="ÿ≥ÿßÿÆÿ™ ÿ™ÿµŸà€åÿ±">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="kinger-ultimate-beyond-icon">
                        <path fill-rule="evenodd" d="M1.5 5.25a3 3 0 0 1 3-3h15a3 3 0 0 1 3 3v13.5a3 3 0 0 1-3 3h-15a3 3 0 0 1-3-3V5.25Zm16.5 9.75a3 3 0 1 0-6 0 3 3 0 0 0 6 0Zm-3-7.5a.75.75 0 0 0-1.5 0v2.25h-2.25a.75.75 0 0 0 0 1.5h2.25v2.25a.75.75 0 0 0 1.5 0v-2.25h2.25a.75.75 0 0 0 0-1.5h-2.25V7.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </footer>
        <div id="messageCount" class="kinger-ultimate-beyond-message-counter">0 Ÿæ€åÿßŸÖ</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const imageButton = document.getElementById("imageButton");
        const sendButton = document.getElementById("sendButton");
        const clearButton = document.getElementById("clearButton");
        const chatInput = document.getElementById("chatInput");
        const chatbox = document.getElementById("chatbox");
        const themeButton = document.getElementById("themeButton");
        const messageCountElem = document.getElementById("messageCount");
        const api2Spinner = document.getElementById("api2-spinner");
        const api2Error = document.getElementById("api2-error");
        const body = document.body;
        const themeDarkIcon = document.querySelector('.theme-dark-icon');
        const themeLightIcon = document.querySelector('.theme-light-icon');
        const ultimateBeyondContainer = document.querySelector('.kinger-ultimate-beyond-container');
        const emptyState = document.getElementById('empty-state');
        const emptyStateAnimation = document.getElementById('empty-state-animation');

        let messageCount = 0;
        let isDarkMode = true;

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            body.classList.toggle('light-theme', savedTheme === 'light');
            isDarkMode = savedTheme !== 'light';
            updateThemeButtonIcon();
        }

        function updateThemeButtonIcon() {
            if (isDarkMode) {
                themeDarkIcon.classList.remove('hidden');
                themeLightIcon.classList.add('hidden');
                themeButton.title = 'ÿ™ÿ∫€å€åÿ± ÿ®Ÿá ÿ™ŸÖ ÿ±Ÿàÿ¥ŸÜ';
            } else {
                themeDarkIcon.classList.add('hidden');
                themeLightIcon.classList.remove('hidden');
                themeButton.title = 'ÿ™ÿ∫€å€åÿ± ÿ®Ÿá ÿ™ŸÖ ÿ™ÿßÿ±€å⁄©';
            }
        }

        themeButton.addEventListener('click', () => {
            body.classList.toggle('light-theme');
            isDarkMode = !isDarkMode;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeButtonIcon();
            VANTA.NET({
                el: "#vanta-net",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                scaleMobile: 1.00,
                color: isDarkMode ? 0x00ffff : 0xffa000, // ÿ™ÿ∫€å€åÿ± ÿ±ŸÜ⁄Ø ÿÆÿ∑Ÿàÿ∑ ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿ™ŸÖ
                backgroundColor: isDarkMode ? 0x050505 : 0xfafafa,
                points: 15.00,
                maxDistance: 20.00,
                spacing: 15.00
            });
        });

        VANTA.NET({
            el: "#vanta-net",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: isDarkMode ? 0x00ffff : 0xffa000,
            backgroundColor: isDarkMode ? 0x050505 : 0xfafafa,
            points: 15.00,
            maxDistance: 20.00,
            spacing: 15.00
        });

        anime({
            targets: '#empty-state-animation',
            loop: true,
            direction: 'alternate',
            easing: 'easeInOutSine',
            opacity: [0.1, 0.9],
            scale: [0.8, 1.2],
            rotate: '360deg',
            duration: 2000
        });

        window.addEventListener("DOMContentLoaded", () => {
            const saved = localStorage.getItem("chatHistory");
            if (saved) {
                chatbox.innerHTML = saved;
                messageCount = chatbox.children.length - 1;
                updateMessageCount();
                chatbox.scrollTop = chatbox.scrollHeight;
                emptyState.classList.add('hidden');
            } else {
                emptyState.classList.remove('hidden');
            }
        });

        window.addEventListener("beforeunload", () => {
            localStorage.setItem("chatHistory", chatbox.innerHTML);
        });

        function updateMessageCount() {
            messageCountElem.textContent = `${messageCount} Ÿæ€åÿßŸÖ`;
        }

        function getTimeString() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function displayMessage(message, isUser) {
            const messageElement = document.createElement("div");
            messageElement.className = isUser ? "user-message kinger-ultimate-beyond-message user" : "assistant-message kinger-ultimate-beyond-message assistant";
            messageElement.innerHTML = marked.parse(message);
            chatbox.appendChild(messageElement);

            // ÿßŸÜ€åŸÖ€åÿ¥ŸÜ Ÿàÿ±ŸàÿØ Ÿæ€åÿßŸÖ
            anime({
                targets: messageElement,
                opacity: [0, 1],
                translateY: [-20, 0],
                duration: 500,
                easing: 'easeOutSine'
            });

            messageCount++;
            updateMessageCount();
            chatbox.scrollTop = chatbox.scrollHeight;
            emptyState.classList.add('hidden');
        }

        async function fetchResponse(userMessage) {
            const typingIndicator = document.createElement("div");
            typingIndicator.className = "typing-indicator kinger-ultimate-beyond-typing-indicator";
            typingIndicator.textContent = "...ÿØÿ± ÿ≠ÿßŸÑ ÿ™ŸÅ⁄©ÿ± ÿπŸÖ€åŸÇ";
            chatbox.appendChild(typingIndicator);

            chatInput.value = "";
            chatInput.disabled = true;
            sendButton.disabled = true;
            imageButton.disabled = true;

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userMessage }),
                });

                const data = await res.json();
                chatbox.removeChild(typingIndicator);
                displayMessage(data.reply, false);

            } catch (err) {
                chatbox.removeChild(typingIndicator);
                displayMessage("ÿÆÿ∑ÿß ÿØÿ± ÿßÿπŸÖÿßŸÇ ŸÅÿ∂ÿß.", false);
            }

            chatInput.disabled = false;
            sendButton.disabled = false;
            imageButton.disabled = false;
            chatInput.focus();
        }

        sendButton.addEventListener("click", () => {
            const userMessage = chatInput.value.trim();
            if (userMessage) {
                displayMessage(userMessage, true);
                fetchResponse(userMessage);
            }
        });

        chatInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendButton.click();
            }
        });

        clearButton.addEventListener("click", () => {
            fetch("/reset", { method: "POST" })
                .then(() => {
                    chatbox.innerHTML = "";
                    messageCount = 0;
                    updateMessageCount();
                    localStorage.removeItem("chatHistory");
                    emptyState.classList.remove('hidden');
                });
        });

        imageButton.addEventListener("click", () => {
            const userPrompt = chatInput.value.trim();
            if (!userPrompt) return;

            displayMessage(userPrompt, true);

            api2Spinner.classList.remove("hidden");
            api2Error.classList.add("hidden");

            chatInput.value = "";
            chatInput.disabled = true;
            sendButton.disabled = true;
            imageButton.disabled = true;

            const prompt = userPrompt;

            fetch("/generate_image", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt })
            })
            .then(res => res.json())
            .then(data => {
                api2Spinner.classList.add("hidden");
                if (data.imageUrl) {
                    const imgWrap = document.createElement("div");
                    imgWrap.className = "assistant-message kinger-ultimate-beyond-message assistant image-message";
                    imgWrap.innerHTML = `<img src="${data.imageUrl}" alt="ÿ™ÿµŸà€åÿ± ÿ≥ÿßÿÆÿ™Ÿá‚Äåÿ¥ÿØŸá ÿØÿ± ÿßÿπŸÖÿßŸÇ" class="kinger-ultimate-beyond-image-generated kinger-ultimate-beyond-image-tilt" />`; // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ⁄©ŸÑÿßÿ≥ ÿ®ÿ±ÿß€å ÿ™€åŸÑÿ™
                    chatbox.appendChild(imgWrap);
                    messageCount++;
                    updateMessageCount();
                    chatbox.scrollTop = chatbox.scrollHeight;
                    emptyState.classList.add('hidden');
                    // ŸÅÿπÿßŸÑ ⁄©ÿ±ÿØŸÜ ÿßŸÅ⁄©ÿ™ ÿ™€åŸÑÿ™ ÿ®ÿ±ÿß€å ÿ™ÿµÿßŸà€åÿ± ÿ¨ÿØ€åÿØ
                    // VanillaTilt.init(document.querySelectorAll(".kinger-ultimate-beyond-image-tilt"), {
                    //     max: 15,
                    //     speed: 400,
                    //     glare: true,
                    //     "max-glare": 0.5
                    // });
                } else {
                    api2Error.classList.remove("hidden");
                    api2Error.textContent = "ŸÖÿ™ÿßÿ≥ŸÅŸÖÿå ŸÜÿ™ŸàŸÜÿ≥ÿ™ŸÖ ÿ™ÿµŸà€åÿ± ⁄©€åŸáÿßŸÜ€å ÿ®ÿ≥ÿßÿ≤ŸÖ.";
                }
            })
            .catch(err => {
                console.error("Image API error:", err);
                api2Spinner.classList.add("hidden");
                api2Error.classList.remove("hidden");
                api2Error.textContent = "ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß API ÿßÿπŸÖÿßŸÇ.";
            })
            .finally(() => {
                chatInput.disabled = false;
                sendButton.disabled = false;
                imageButton.disabled = false;
                chatInput.focus();
            });
        });

    </script>
</body>
</html>
